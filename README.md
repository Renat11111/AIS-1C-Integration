# AIS-1C Integration Service

Высокопроизводительный сервис-шлюз для гарантированной интеграции между **AIS** и **1С:Предприятие**.

Сервис работает как буфер: мгновенно принимает данные, сохраняет их на диск и в фоновом режиме отправляет в 1С, сглаживая пиковые нагрузки.

---

## 🚀 Ключевые возможности

1.  **Гарантированная доставка:** 
    *   Входящие данные мгновенно сохраняются во встроенную БД (PocketBase/SQLite).
    *   Даже при сбое питания данные не пропадут (хранятся на диске).
    *   Запись удаляется из БД **только** после успешного ответа от 1С (200 OK).

2.  **Производительность:**
    *   **Worker Pool:** 5 параллельных потоков отправки в 1С.
    *   **Batch Processing:** Эффективная выборка данных пачками.
    *   **Zero-Allocation:** Оптимизированная работа с памятью.

3.  **API и Валидация:**
    *   Поддержка методов POST (Продажа), PUT (Обновление), DELETE (Отмена).
    *   Строгая валидация обязательных полей (например, для отмены обязательны дата, пользователь и причина).
    *   Swagger-документация.

4.  **Мониторинг (All-in-One):**
    *   Встроенные метрики Prometheus.
    *   Автоматическая установка Grafana с готовыми дашбордами.

---

## 📦 Установка и Запуск (Для Клиента)

Весь сервис находится в папке **uild**. Для переноса на сервер достаточно скопировать только эту папку.

### Шаг 1: Подготовка
1. Скопируйте папку uild на сервер.
2. Откройте файл uild\.env и пропишите настройки 1С:
   `ini
   SERVER_PORT=:8081
   AIS_TOKEN=ваш-секретный-ключ
   ONEC_BASE_URL=http://адрес-1с/base/hs/ais/v1/data
   ONEC_USER=admin
   ONEC_PASSWORD=пароль
   `

### Шаг 2: Установка мониторинга (Один раз)
Запустите uild\setup.bat.
*   Скрипт автоматически скачает Prometheus и Grafana.
*   Развернет их в папку monitoring рядом с сервером.
*   Настроит дашборды.

### Шаг 3: Запуск
Запустите uild\start.bat.
*   Запустится основной сервис интеграции.
*   (Если установлен) Запустится мониторинг в свернутом режиме.
*   Скрипт будет следить за работой и **автоматически перезапустит** сервис в случае сбоя.

---

## 💻 Интерфейсы

После запуска вам доступны:

| Сервис | Адрес | Описание |
| :--- | :--- | :--- |
| **API Endpoint** | http://localhost:8081/api/v1/data | Точка входа для AIS (POST, PUT, DELETE) |
| **Swagger UI** | http://localhost:8081/swagger/index.html | Документация для разработчиков |
| **Grafana** | http://localhost:3000 | Красивые графики (Login: dmin / dmin) |
| **Admin UI** | http://localhost:8081/_/ | Ручной просмотр очереди сообщений |
| **Метрики** | http://localhost:8081/metrics | Сырые данные для Prometheus |

---

## 📡 Формат данных

Сервис ожидает JSON с заголовком X-API-Key.

**Пример (Отмена продажи - DELETE):**
`json
{
  "id": "msg-001",
  "type": "sale_cancel",
  "data": {
    "SaleId": "SALE-12345",
    "SaleDate": "2023-12-22T10:00:00",
    "UserId": "USER-007",
    "SaleComment": "Ошибка оператора"
  }
}
`
*Подробные схемы данных см. в Swagger.*

---

## ⚠️ Важное примечание

По умолчанию сервер собран в режиме **DRY RUN** (Тестовый режим).
В этом режиме он **принимает** данные, сохраняет в БД, но **не отправляет** их реально в 1С (имитирует успех и удаляет из очереди).

Для переключения в боевой режим:
1. Откройте исходный код internal/service/onec/service.go.
2. Раскомментируйте блок в функции sendToOneC.
3. Пересоберите проект (или попросите разработчика прислать боевой server.exe).
