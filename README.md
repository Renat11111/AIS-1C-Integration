# AIS-1C Integration Service (AIS-1C Proxy)

Высокопроизводительный сервис интеграции для гарантированной доставки данных из системы **AIS** в **1С:Предприятие**.

## 🚀 Основные возможности

*   **Гарантированная доставка:** Все входящие запросы сохраняются в локальную БД (PocketBase/SQLite) перед обработкой. Потеря данных исключена даже при сбое питания.
*   **Защита 1С:** Реализован **Worker Pool** (по умолчанию 5 потоков). Сервер сглаживает пиковые нагрузки, отправляя данные в 1С равномерно.
*   **Идемпотентность:** Повторные запросы с одним и тем же id игнорируются, но возвращают успешный статус.
*   **Наблюдаемость:** Встроенные метрики Prometheus и структурированные JSON-логи (Zerolog).
*   **API:** Поддержка операций POST (создание), PUT (обновление), DELETE (удаление) с валидацией JSON.

---

## 🛠 Архитектура

1.  **Frontend (AIS):** Отправляет HTTP запросы на :8081/api/v1/data.
2.  **Proxy (Go):** 
    *   Валидирует токен (X-API-Key) с защитой от Timing Attack.
    *   Сохраняет запрос в очередь integration_queue (статус pending).
    *   Сразу возвращает 200 OK.
3.  **Dispatcher (Go):** Фоновый процесс сканирует БД и распределяет задачи по воркерам.
4.  **Backend (1C):** Воркеры отправляют данные в HTTP-сервис 1С.
    *   Успех -> Запись удаляется из БД.
    *   Ошибка -> Статус меняется на error, ошибка записывается в лог.

---

## ⚡ Быстрый старт (Windows)

### 1. Установка
Запустите скрипт установки зависимостей (скачает Prometheus):
uild\setup.bat

### 2. Конфигурация
Отредактируйте файл .env в корне проекта:
`ini
SERVER_PORT=:8081
AIS_TOKEN=ваш-секретный-ключ
ONEC_BASE_URL=http://сервер-1с/base/hs/ais/v1/data
ONEC_USER=admin
ONEC_PASSWORD=secret
`

### 3. Запуск
Запустите основной скрипт:
uild\start.bat

Откроется консоль супервизора, который:
1.  Скомпилирует проект.
2.  Запустит Prometheus (фоном).
3.  Запустит Сервер.
4.  Будет автоматически перезапускать сервер при падении.

---

## 📡 API Endpoints

**Base URL:** http://localhost:8081

### 1. Прием данных
*   **URL:** /api/v1/data
*   **Methods:** POST, PUT, DELETE
*   **Headers:** X-API-Key: <ваш-токен>
*   **Body:** JSON

**Пример запроса (POST):**
`json
{
  "id": "unique-msg-id-001",
  "type": "sale",
  "timestamp": 1700000000,
  "data": {
    "SaleId": "sale-123",
    "SaleMainAmount": 1500.00,
    "SaleDetails": [
      {
        "SaleDetailId": "det-1",
        "SaleDetailPrice": 100.00
      }
    ]
  }
}
`

### 2. Swagger Документация
Подробное описание API доступно в браузере:
http://localhost:8081/swagger/index.html

### 3. Админка (Очередь)
Просмотр очереди сообщений вручную:
http://localhost:8081/_/

---

## 📊 Мониторинг

Сервер отдает метрики в формате Prometheus на порту 8081: http://localhost:8081/metrics

В комплекте идет настроенный **Prometheus** (порт 9090).
Ключевые метрики:
*   is_queue_depth — Количество задач в ожидании (должно быть около 0).
*   is_worker_duration_seconds — Гистограмма времени ответа 1С.
*   is_processed_total — Счетчик успешных/неуспешных отправок.

---

## 📂 Структура проекта

*   cmd/api — Точка входа (main.go).
*   internal/config — Загрузка .env.
*   internal/models — Структуры данных (AISRequest, AISDocument).
*   internal/service/onec — Логика очереди (PocketBase) и отправки (HTTP Client).
*   internal/transport — HTTP хендлеры.
*   uild/ — Скрипты запуска (start.bat, setup.bat).
*   monitoring/ — Prometheus и конфиги.

---

## ⚠️ Важно

По умолчанию сервер работает в режиме **DRY RUN** (Симуляция отправки).
Чтобы включить реальную отправку в 1С, раскомментируйте блок кода в файле:
internal/service/onec/service.go (метод sendToOneC).
